name: Generate Vocabulary HTML Files
# vocabulary_data*.json ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  push:
    branches:
      - main
    paths:
      - 'english_dictionary/vocabulary_data*.json' # ãƒ‘ã‚¹ã‚’å¤‰æ›´
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  generate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. dataãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆï¼ˆenglish_dictionaryã®ä¸‹ã«ä½œæˆï¼‰
      - name: Create data directory
        run: mkdir -p english_dictionary/data
      
      # 4. å˜èªžHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
      - name: Generate vocabulary HTML files
        run: |
          echo "ðŸ”§ Generating HTML files..."
          python english_dictionary/generate_vocab.py
          echo ""
          echo "ðŸ“ Files in data/ directory (æœ€åˆã®20ä»¶):"
          ls -lh english_dictionary/data/ | head -20
          echo ""
          echo "ðŸ“Š Total HTML files:"
          ls -1 english_dictionary/data/*.html 2>/dev/null | wc -l
      
      # 5. index.htmlã‚’æ›´æ–°
      - name: Update index.html
        run: |
          python english_dictionary/build_index.py
          echo "âœ… index.html updated"

      # 5.5. exercise.htmlã‚’æ›´æ–°
      - name: Update exercise.html
        run: |
          python english_dictionary/generate_exercise.py
          echo "âœ… exercise.html updated"
      
      # 6. å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ (ç›£è¦–ãƒ‘ã‚¹ã‚’ english_dictionary/ å†…ã«å¤‰æ›´)
      - name: Check for changes
        id: check_changes
        run: |
          TARGET_PATHS="english_dictionary/data/ english_dictionary/index.html english_dictionary/exercise.html"
          if [ -n "$(git status --porcelain $TARGET_PATHS)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            git status --porcelain $TARGET_PATHS
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      # 7. ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ­£ã—ã„ãƒ‘ã‚¹ã§add
          git add english_dictionary/data/*.html
          git add english_dictionary/index.html
          git add english_dictionary/exercise.html
          
          git commit -m "ðŸ¤– Auto-generate vocabulary HTML files [skip ci]"
          git push
      
      # 8. å®Œäº†ã‚µãƒžãƒªãƒ¼
      - name: Job summary
        run: |
          echo "## ðŸ“Š Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
          cd english_dictionary
          for file in vocabulary_data*.json; do
            if [ -f "$file" ]; then
              count=$(python3 -c "import json; print(len(json.load(open('$file'))['words']))" 2>/dev/null || echo "0")
              echo "- \`$file\`: $count words" >> $GITHUB_STEP_SUMMARY
            fi
          done
          total=$(ls -1 data/*.html 2>/dev/null | wc -l)
          echo "- Total: **$total HTML files** in \`data/\` directory" >> $GITHUB_STEP_SUMMARY
